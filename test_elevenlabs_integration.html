<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎙️ Test Intégration ElevenLabs - Interface ENIAD</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .header h1 {
            color: #10a37f;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .status-card {
            border: 2px solid #e5e7eb;
            border-radius: 15px;
            padding: 20px;
            background: #f9fafb;
        }
        
        .status-card.success {
            border-color: #10a37f;
            background: linear-gradient(135deg, #ecfdf5 0%, #f0fdf4 100%);
        }
        
        .status-card.error {
            border-color: #ef4444;
            background: linear-gradient(135deg, #fef2f2 0%, #fef2f2 100%);
        }
        
        .status-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-description {
            color: #6b7280;
            margin-bottom: 15px;
        }
        
        .feature-list {
            list-style: none;
            padding: 0;
        }
        
        .feature-list li {
            padding: 5px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .test-section {
            background: #f8fafc;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
        }
        
        .test-title {
            color: #1f2937;
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .message-bubble {
            background: linear-gradient(135deg, rgba(16,163,127,0.12) 0%, rgba(16,163,127,0.06) 100%);
            border: 1px solid rgba(16,163,127,0.2);
            border-radius: 20px;
            padding: 20px;
            margin: 15px 0;
            position: relative;
            box-shadow: 0 4px 20px rgba(16,163,127,0.12);
        }
        
        .message-content {
            margin-bottom: 15px;
            line-height: 1.6;
        }
        
        .message-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .tts-button {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #10a37f 0%, #059669 100%);
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .tts-button:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(16,163,127,0.3);
        }
        
        .tts-button.speaking {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        .tts-button.loading {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        
        .floating-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, rgba(16,163,127,0.95) 0%, rgba(5,150,105,0.95) 100%);
            color: white;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(16,163,127,0.3);
            backdrop-filter: blur(20px);
            min-width: 300px;
            display: none;
        }
        
        .floating-panel.visible {
            display: block;
            animation: slideUp 0.4s ease-out;
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .panel-title {
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .close-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
        }
        
        .progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: white;
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        
        .info-box {
            background: #e0f2fe;
            border: 1px solid #0277bd;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .lang-indicator {
            background: rgba(255,255,255,0.2);
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.8rem;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎙️ Test Intégration ElevenLabs</h1>
            <p>Interface ENIAD Assistant avec TTS Premium</p>
        </div>

        <!-- Status des fonctionnalités -->
        <div class="status-grid">
            <div class="status-card success">
                <div class="status-title">
                    ✅ ElevenLabs TTS
                </div>
                <div class="status-description">
                    Service de synthèse vocale premium intégré
                </div>
                <ul class="feature-list">
                    <li>🎯 Qualité premium</li>
                    <li>🌐 Support multilingue (FR/AR)</li>
                    <li>⚡ Détection automatique de langue</li>
                    <li>🔧 Configuration zéro</li>
                </ul>
            </div>

            <div class="status-card success">
                <div class="status-title">
                    🎛️ Interface Améliorée
                </div>
                <div class="status-description">
                    Boutons TTS dynamiques avec états visuels
                </div>
                <ul class="feature-list">
                    <li>🔄 États: Idle/Loading/Speaking</li>
                    <li>🎨 Animations fluides</li>
                    <li>📱 Design responsive</li>
                    <li>🌙 Support mode sombre</li>
                </ul>
            </div>

            <div class="status-card success">
                <div class="status-title">
                    🎯 Panneau Flottant
                </div>
                <div class="status-description">
                    Contrôle TTS avancé avec progression
                </div>
                <ul class="feature-list">
                    <li>📊 Barre de progression</li>
                    <li>⏱️ Estimation de durée</li>
                    <li>🎮 Contrôles play/stop</li>
                    <li>📝 Aperçu du texte</li>
                </ul>
            </div>
        </div>

        <!-- Test des messages -->
        <div class="test-section">
            <h3 class="test-title">🧪 Test des Messages avec TTS</h3>
            
            <div class="message-bubble">
                <div class="message-content">
                    <strong>Assistant:</strong> Bonjour et bienvenue à l'École Nationale d'Intelligence Artificielle de Berkane. Notre établissement offre une formation de pointe en IA et technologies numériques.
                </div>
                <div class="message-actions">
                    <button class="tts-button" onclick="testTTS('Bonjour et bienvenue à l\'École Nationale d\'Intelligence Artificielle de Berkane. Notre établissement offre une formation de pointe en IA et technologies numériques.', 'fr', this)">
                        🎤 Lire (FR)
                    </button>
                </div>
            </div>

            <div class="message-bubble">
                <div class="message-content" style="text-align: right; direction: rtl;">
                    <strong>المساعد:</strong> مرحباً بكم في المدرسة الوطنية للذكاء الاصطناعي والرقمي ببركان. نحن نقدم تعليماً متقدماً في مجال الذكاء الاصطناعي والتقنيات الرقمية.
                </div>
                <div class="message-actions">
                    <button class="tts-button" onclick="testTTS('مرحباً بكم في المدرسة الوطنية للذكاء الاصطناعي والرقمي ببركان. نحن نقدم تعليماً متقدماً في مجال الذكاء الاصطناعي والتقنيات الرقمية.', 'ar', this)">
                        🎤 قراءة (AR)
                    </button>
                </div>
            </div>

            <div class="message-bubble">
                <div class="message-content">
                    <strong>Assistant:</strong> L'intelligence artificielle transforme notre façon d'apprendre, d'enseigner et de résoudre les problèmes complexes. À ENIAD, nous préparons les étudiants aux défis de demain.
                </div>
                <div class="message-actions">
                    <button class="tts-button" onclick="testTTS('L\'intelligence artificielle transforme notre façon d\'apprendre, d\'enseigner et de résoudre les problèmes complexes. À ENIAD, nous préparons les étudiants aux défis de demain.', 'auto', this)">
                        🎯 Auto-détection
                    </button>
                </div>
            </div>
        </div>

        <!-- Informations techniques -->
        <div class="info-box">
            <h4>ℹ️ Fonctionnalités Intégrées</h4>
            <p><strong>✅ Intégration Complète:</strong></p>
            <ul>
                <li>🎙️ <strong>ElevenLabs TTS</strong> - Service principal avec qualité premium</li>
                <li>🔧 <strong>Hook useTTSState</strong> - Gestion d'état avancée</li>
                <li>🎛️ <strong>Composant TTSButton</strong> - Boutons dynamiques avec animations</li>
                <li>📱 <strong>Panneau TTSFloatingPanel</strong> - Interface de contrôle flottante</li>
                <li>🌐 <strong>Détection automatique</strong> - Reconnaissance FR/AR intelligente</li>
                <li>⚡ <strong>États visuels</strong> - Loading/Speaking/Idle avec feedback</li>
            </ul>
            <br>
            <p><strong>🚀 Avantages:</strong></p>
            <ul>
                <li>Configuration zéro - Fonctionne immédiatement</li>
                <li>Qualité audio premium constante</li>
                <li>Support multilingue excellent</li>
                <li>Interface utilisateur intuitive</li>
                <li>Performance optimisée</li>
            </ul>
        </div>
    </div>

    <!-- Panneau flottant -->
    <div id="floatingPanel" class="floating-panel">
        <div class="panel-header">
            <div class="panel-title">
                🎙️ ElevenLabs TTS
                <span id="langIndicator" class="lang-indicator">FR</span>
            </div>
            <button class="close-btn" onclick="hideFloatingPanel()">×</button>
        </div>
        <div id="currentText" style="font-style: italic; margin-bottom: 10px; font-size: 0.9rem;">
            Texte en cours de lecture...
        </div>
        <div class="progress-bar">
            <div id="progressFill" class="progress-fill" style="width: 0%"></div>
        </div>
        <div style="display: flex; justify-content: center; margin-top: 15px;">
            <button id="controlBtn" class="tts-button" onclick="togglePlayback()">
                ⏸️ Arrêter
            </button>
        </div>
    </div>

    <script>
        let currentAudio = null;
        let currentButton = null;
        let progressInterval = null;

        async function testTTS(text, language, button) {
            // Si déjà en cours, arrêter
            if (currentAudio && !currentAudio.paused) {
                stopCurrentTTS();
                return;
            }

            try {
                // Détecter la langue si auto
                let detectedLang = language;
                if (language === 'auto') {
                    detectedLang = detectLanguage(text);
                }

                // Mettre à jour l'interface
                updateButtonState(button, 'loading');
                showFloatingPanel(text, detectedLang);

                console.log(`🎙️ Testing ElevenLabs TTS for language: ${detectedLang}`);

                // Nettoyer le texte
                const cleanText = text.replace(/\*/g, '').replace(/[#*_`]/g, '').trim();
                
                const voiceId = "JBFqnCBsd6RMkjVDRZzb";
                
                const startTime = Date.now();
                const response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${voiceId}`, {
                    method: 'POST',
                    headers: {
                        'Accept': 'audio/mpeg',
                        'Content-Type': 'application/json',
                        'xi-api-key': 'sk_d8fc9625fbfd20f51143215781f41238b0f80986af1648ef'
                    },
                    body: JSON.stringify({
                        text: cleanText,
                        model_id: 'eleven_multilingual_v2',
                        voice_settings: {
                            stability: 0.5,
                            similarity_boost: 0.75,
                            style: 0.0,
                            use_speaker_boost: true
                        }
                    })
                });
                
                const latency = Date.now() - startTime;
                
                if (!response.ok) {
                    throw new Error(`ElevenLabs API error: ${response.status}`);
                }
                
                const audioBuffer = await response.arrayBuffer();
                const audioBlob = new Blob([audioBuffer], { type: 'audio/mpeg' });
                const audio = new Audio(URL.createObjectURL(audioBlob));
                
                currentAudio = audio;
                currentButton = button;
                
                // Mettre à jour l'interface
                updateButtonState(button, 'speaking');
                startProgress(audio.duration || estimateDuration(text));
                
                audio.onended = () => {
                    stopCurrentTTS();
                };
                
                await audio.play();
                
                console.log(`✅ TTS completed (${latency}ms, ${Math.round(audioBuffer.byteLength / 1024)}KB)`);
                
            } catch (error) {
                console.error('❌ TTS Error:', error);
                updateButtonState(button, 'error');
                hideFloatingPanel();
            }
        }

        function detectLanguage(text) {
            const arabicRegex = /[\u0600-\u06FF\u0750-\u077F]/;
            if (arabicRegex.test(text)) {
                return 'ar';
            }
            return 'fr';
        }

        function estimateDuration(text) {
            const wordsPerMinute = 150;
            const wordCount = text.split(/\s+/).length;
            return Math.max((wordCount / wordsPerMinute) * 60, 2);
        }

        function updateButtonState(button, state) {
            button.className = `tts-button ${state}`;
            
            switch (state) {
                case 'loading':
                    button.innerHTML = '⏳ Chargement...';
                    break;
                case 'speaking':
                    button.innerHTML = '⏸️ Arrêter';
                    break;
                case 'error':
                    button.innerHTML = '❌ Erreur';
                    setTimeout(() => {
                        button.className = 'tts-button';
                        button.innerHTML = button.innerHTML.replace('❌ Erreur', '🎤 Lire');
                    }, 2000);
                    break;
                default:
                    button.innerHTML = button.innerHTML.replace(/[⏳⏸️❌][^🎤]*/, '🎤 ');
                    break;
            }
        }

        function showFloatingPanel(text, language) {
            const panel = document.getElementById('floatingPanel');
            const textElement = document.getElementById('currentText');
            const langIndicator = document.getElementById('langIndicator');
            
            textElement.textContent = text.length > 80 ? text.substring(0, 80) + '...' : text;
            langIndicator.textContent = language.toUpperCase();
            
            panel.classList.add('visible');
        }

        function hideFloatingPanel() {
            const panel = document.getElementById('floatingPanel');
            panel.classList.remove('visible');
            stopProgress();
        }

        function startProgress(duration) {
            const progressFill = document.getElementById('progressFill');
            let progress = 0;
            const increment = 100 / (duration * 10); // 10 updates per second
            
            progressInterval = setInterval(() => {
                progress += increment;
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(progressInterval);
                }
                progressFill.style.width = progress + '%';
            }, 100);
        }

        function stopProgress() {
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }
            document.getElementById('progressFill').style.width = '0%';
        }

        function stopCurrentTTS() {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }
            
            if (currentButton) {
                updateButtonState(currentButton, 'idle');
                currentButton = null;
            }
            
            hideFloatingPanel();
        }

        function togglePlayback() {
            stopCurrentTTS();
        }

        // Test initial
        console.log('🎙️ ElevenLabs TTS Integration Test Ready');
        console.log('✅ Interface components loaded');
        console.log('✅ Floating panel ready');
        console.log('✅ Multi-language support active');
    </script>
</body>
</html>
